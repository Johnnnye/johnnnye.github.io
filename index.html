<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>John Emslie – Sound Designer & Composer</title>
  <link rel="stylesheet" href="style.css">
</head>
<body>

<main class="container">

  <section class="hero">
    <h1 id="about-trigger">John Emslie</h1>
    <p class="role">Sound Designer & Composer</p>
  </section>

  <section class="categories">
    <div class="node" data-note="146.83" style="top:32%; left:30%;">Picture</div>
    <div class="node" data-note="174.61" style="top:50%; left:62%;">Music</div>
    <div class="node" data-note="196.00" style="top:68%; left:40%;">Redesigns</div>
    <div class="node" data-note="220.00" style="top:78%; left:58%;">Games</div>
  </section>

  <footer class="contact">
    <a href="mailto:john@youremail.com" id="contact">john@youremail.com</a>
  </footer>

</main>

<script>
/* =========================
   AUDIO – SINGLE SOURCE OF TRUTH
========================= */

let ctx;
let master;
let reverb;
let breathGain;
let breathOsc;
let nodes = [];
let unlocked = false;

/* ---------- UNLOCK ---------- */
function unlock() {
  if (unlocked) return;

  ctx = new (window.AudioContext || window.webkitAudioContext)();

  master = ctx.createGain();
  master.gain.value = 0.25;
  master.connect(ctx.destination);

  // Reverb
  reverb = ctx.createConvolver();
  const ir = ctx.createBuffer(2, ctx.sampleRate * 2, ctx.sampleRate);
  for (let c = 0; c < 2; c++) {
    const d = ir.getChannelData(c);
    for (let i = 0; i < d.length; i++) {
      d[i] = (Math.random() * 2 - 1) * Math.exp(-i / (ctx.sampleRate * 0.6));
    }
  }
  reverb.buffer = ir;

  const revGain = ctx.createGain();
  revGain.gain.value = 0.25;
  reverb.connect(revGain);
  revGain.connect(master);

  buildBreath();
  buildNodes();
  buildContact();

  unlocked = true;
}

window.addEventListener("mousedown", unlock, { once: true });
window.addEventListener("mousemove", unlock, { once: true });

/* ---------- BREATH (ALWAYS ON) ---------- */
function buildBreath() {
  breathOsc = ctx.createOscillator();
  breathOsc.type = "sine";
  breathOsc.frequency.value = 0.08; // LFO rate

  breathGain = ctx.createGain();
  breathGain.gain.value = 0;

  const noise = ctx.createBufferSource();
  const buffer = ctx.createBuffer(1, ctx.sampleRate * 2, ctx.sampleRate);
  const data = buffer.getChannelData(0);
  for (let i = 0; i < data.length; i++) data[i] = Math.random() * 2 - 1;
  noise.buffer = buffer;
  noise.loop = true;

  const filter = ctx.createBiquadFilter();
  filter.type = "bandpass";
  filter.frequency.value = 600;
  filter.Q.value = 0.8;

  breathOsc.connect(breathGain);
  breathGain.connect(filter.frequency);
  noise.connect(filter);
  filter.connect(reverb);

  breathOsc.start();
  noise.start();
}

/* ---------- NODES ---------- */
function buildNodes() {
  document.querySelectorAll(".node").forEach(el => {
    const osc = ctx.createOscillator();
    osc.type = "sine";
    osc.frequency.value = parseFloat(el.dataset.note);

    const gain = ctx.createGain();
    gain.gain.value = 0;

    osc.connect(gain);
    gain.connect(master);
    gain.connect(reverb);

    osc.start();

    el.addEventListener("mouseenter", () => {
      gain.gain.setTargetAtTime(0.06, ctx.currentTime, 0.8);
    });

    el.addEventListener("mouseleave", () => {
      gain.gain.setTargetAtTime(0, ctx.currentTime, 1.2);
    });

    el.addEventListener("click", clickSound);
  });
}

/* ---------- CONTACT (FIXED) ---------- */
function buildContact() {
  const el = document.getElementById("contact");

  const osc = ctx.createOscillator();
  osc.type = "sine";
  osc.frequency.value = 146.83 * 1.5;

  const gain = ctx.createGain();
  gain.gain.value = 0;

  osc.connect(gain);
  gain.connect(master);
  gain.connect(reverb);
  osc.start();

  el.addEventListener("mouseenter", () => {
    gain.gain.setTargetAtTime(0.04, ctx.currentTime, 1);
  });

  el.addEventListener("mouseleave", () => {
    gain.gain.setTargetAtTime(0, ctx.currentTime, 1.5);
  });

  el.addEventListener("click", e => {
    e.preventDefault();          // CRITICAL
    clickSound();
    setTimeout(() => {
      window.location.href = el.href;
    }, 120);
  });
}

/* ---------- CLICK ---------- */
function clickSound() {
  if (!unlocked) return;

  const osc = ctx.createOscillator();
  const gain = ctx.createGain();

  osc.type = "sine";
  osc.frequency.value = 140;

  const t = ctx.currentTime;
  gain.gain.setValueAtTime(0, t);
  gain.gain.linearRampToValueAtTime(0.06, t + 0.02);
  gain.gain.exponentialRampToValueAtTime(0.0001, t + 0.5);

  osc.connect(gain);
  gain.connect(master);
  gain.connect(reverb);

  osc.start(t);
  osc.stop(t + 0.6);
}
</script>

</body>
</html>
